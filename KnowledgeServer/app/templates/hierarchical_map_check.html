<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hierarchical Map API Check</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        h3 {
            color: #444;
            margin-bottom: 15px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background-color: #6366f1;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #5145cd;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        
        #results {
            margin-top: 20px;
            display: none;
        }
        
        pre {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #ddd;
            font-size: 12px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-box {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        #visualization {
            margin-top: 20px;
            text-align: center;
        }
        
        canvas {
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .level-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .level-btn {
            padding: 8px 16px;
            border: 2px solid #6366f1;
            background: white;
            color: #6366f1;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .level-btn.active {
            background: #6366f1;
            color: white;
        }
        
        .cluster-legend {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è Hierarchical Voronoi Map API Check</h1>
        <p>Test the hierarchical clustering with multi-level Voronoi diagram generation.</p>
        
        <h3>Generation Parameters</h3>
        <div class="controls">
            <div class="control-group">
                <label for="sample_size">Sample Size:</label>
                <input type="number" id="sample_size" value="500" min="50" max="2000">
            </div>
            
            <div class="control-group">
                <label for="level_1_clusters">Level 1 Clusters:</label>
                <input type="number" id="level_1_clusters" value="5" min="2" max="20">
            </div>
            
            <div class="control-group">
                <label for="level_2_clusters">Level 2 Clusters:</label>
                <input type="number" id="level_2_clusters" value="15" min="5" max="50">
            </div>
            
            <div class="control-group">
                <label for="level_3_clusters">Level 3 Clusters:</label>
                <input type="number" id="level_3_clusters" value="45" min="10" max="100">
            </div>
        </div>
        
        <h3>Embedding Weights</h3>
        <div class="controls">
            <div class="control-group">
                <label for="clip_weight">CLIP Weight:</label>
                <input type="number" id="clip_weight" value="2.0" min="0" max="10" step="0.1">
            </div>
            
            <div class="control-group">
                <label for="keyword_weight">Keyword Weight:</label>
                <input type="number" id="keyword_weight" value="1.0" min="0" max="10" step="0.1">
            </div>
            
            <div class="control-group">
                <label for="artist_weight">Artist Weight:</label>
                <input type="number" id="artist_weight" value="3.0" min="0" max="10" step="0.1">
            </div>
        </div>
        
        <h3>Algorithm Parameters</h3>
        <div class="controls">
            <div class="control-group">
                <label for="clustering_method">Clustering Method:</label>
                <select id="clustering_method">
                    <option value="ward">Ward</option>
                    <option value="complete">Complete</option>
                    <option value="average">Average</option>
                    <option value="single">Single</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="umap_random_state">UMAP Random State:</label>
                <input type="number" id="umap_random_state" value="42" min="0" max="999999">
            </div>
            
            <div class="control-group">
                <label for="stratify_by_artist">Stratify by Artist:</label>
                <select id="stratify_by_artist">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="debug">Debug Mode:</label>
                <select id="debug">
                    <option value="false">No</option>
                    <option value="true">Yes</option>
                </select>
            </div>
        </div>
        
        <button id="generateBtn" onclick="generateHierarchicalMap()">
            üó∫Ô∏è Generate Hierarchical Voronoi Map
        </button>
        
        <div id="status"></div>
        <div id="timer" style="margin-top:8px;font-size:14px;color:#666;display:none;"></div>
        
        <div id="results">
            <h3>Results</h3>
            <div class="stats" id="stats"></div>
            
            <div id="visualization">
                <h4>Hierarchical Visualization</h4>
                <div class="level-controls">
                    <button class="level-btn active" onclick="showLevel(1)">Level 1</button>
                    <button class="level-btn" onclick="showLevel(2)">Level 2</button>
                    <button class="level-btn" onclick="showLevel(3)">Level 3</button>
                </div>
                <canvas id="hierarchical-canvas" width="800" height="600"></canvas>
                <div class="cluster-legend" id="legend"></div>
            </div>
            
            <details style="margin-top: 20px;">
                <summary>View Raw Response</summary>
                <pre id="response"></pre>
            </details>
        </div>
    </div>

    <script>
        let currentMapData = null;
        let currentLevel = 1;
        let timerInterval = null;
        let timerStart = null;

        const levelColors = {
            1: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff6348'],
            2: ['#ff7675', '#74b9ff', '#0984e3', '#00b894', '#00cec9', '#fdcb6e', '#e17055', '#fd79a8', '#6c5ce7', '#a29bfe', '#2d3436', '#636e72', '#ddd', '#fab1a0', '#e84393'],
            3: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff6348', '#ff7675', '#74b9ff', '#0984e3', '#00b894', '#00cec9', '#fdcb6e', '#e17055', '#fd79a8', '#6c5ce7', '#a29bfe', '#55a3ff', '#26de81', '#fc5c65', '#fed330', '#fd9644', '#fa8231', '#20bf6b', '#0fb9b1', '#45aaf2', '#4b7bec', '#a55eea', '#778ca3', '#2c2c54', '#40407a', '#706fd3', '#f7f1e3', '#34ace0', '#33d9b2', '#ff5252', '#ff793f', '#d63031', '#74b9ff', '#0984e3', '#00b894', '#00cec9']
        };

        function startTimer() {
            timerStart = Date.now();
            const timerDiv = document.getElementById('timer');
            timerDiv.style.display = 'block';
            timerDiv.textContent = "Elapsed: 0.00s";
            timerInterval = setInterval(() => {
                const elapsed = ((Date.now() - timerStart) / 1000).toFixed(2);
                timerDiv.textContent = `Elapsed: ${elapsed}s`;
            }, 50);
        }

        function stopTimer(finalText) {
            clearInterval(timerInterval);
            timerInterval = null;
            const timerDiv = document.getElementById('timer');
            if (finalText) {
                timerDiv.textContent = finalText;
            }
        }

        async function generateHierarchicalMap() {
            const btn = document.getElementById('generateBtn');
            const status = document.getElementById('status');
            const results = document.getElementById('results');

            // Get parameters
            const params = {
                sample_size: document.getElementById('sample_size').value,
                level_1_clusters: document.getElementById('level_1_clusters').value,
                level_2_clusters: document.getElementById('level_2_clusters').value,
                level_3_clusters: document.getElementById('level_3_clusters').value,
                clip_weight: document.getElementById('clip_weight').value,
                keyword_weight: document.getElementById('keyword_weight').value,
                artist_weight: document.getElementById('artist_weight').value,
                clustering_method: document.getElementById('clustering_method').value,
                umap_random_state: document.getElementById('umap_random_state').value,
                stratify_by_artist: document.getElementById('stratify_by_artist').value,
                debug: document.getElementById('debug').value
            };

            const queryString = new URLSearchParams(params).toString();

            btn.disabled = true;
            status.className = 'loading';
            status.textContent = `Generating hierarchical Voronoi map with ${params.sample_size} images...`;
            status.style.display = 'block';
            results.style.display = 'none';
            startTimer();

            try {
                const response = await fetch(`/generate_hierarchical_voronoi?${queryString}`);
                const data = await response.json();

                const elapsed = ((Date.now() - timerStart) / 1000).toFixed(2);
                stopTimer(`Total time: ${elapsed}s`);

                if (data.success) {
                    status.className = 'success';
                    status.textContent = `Success! Generated hierarchical map with ${data.count} points in ${elapsed} seconds.`;

                    // Update stats
                    const statsDiv = document.getElementById('stats');
                    statsDiv.innerHTML = `
                        <div class="stat-box">
                            <div class="stat-label">Total Points</div>
                            <div class="stat-value">${data.count}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Level 1 Regions</div>
                            <div class="stat-value">${data.regions?.level_1?.length || 0}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Level 2 Regions</div>
                            <div class="stat-value">${data.regions?.level_2?.length || 0}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Level 3 Regions</div>
                            <div class="stat-value">${data.regions?.level_3?.length || 0}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Algorithm</div>
                            <div class="stat-value">${data.generationParams?.hierarchical_params?.method || 'N/A'}</div>
                        </div>
                    `;

                    // Store data and show results
                    currentMapData = data;
                    document.getElementById('response').textContent = JSON.stringify(data, null, 2);
                    results.style.display = 'block';

                    // Draw visualization
                    drawHierarchicalVisualization(data, 1);
                    updateLegend(1);

                } else {
                    status.className = 'error';
                    status.textContent = `Error: ${data.error}`;
                    document.getElementById('response').textContent = JSON.stringify(data, null, 2);
                    results.style.display = 'block';
                }
            } catch (error) {
                stopTimer();
                status.className = 'error';
                status.textContent = `Network error: ${error.message}`;
            } finally {
                btn.disabled = false;
            }
        }

        function showLevel(level) {
            currentLevel = level;
            
            // Update button states
            document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.level-btn:nth-child(${level})`).classList.add('active');
            
            if (currentMapData) {
                drawHierarchicalVisualization(currentMapData, level);
                updateLegend(level);
            }
        }

        function drawHierarchicalVisualization(data, level) {
            const canvas = document.getElementById('hierarchical-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const imagePoints = data.imagePoints || [];
            if (imagePoints.length === 0) return;

            // Find bounds for scaling
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            imagePoints.forEach(pt => {
                if (pt.x < minX) minX = pt.x;
                if (pt.x > maxX) maxX = pt.x;
                if (pt.y < minY) minY = pt.y;
                if (pt.y > maxY) maxY = pt.y;
            });

            const pad = 40;
            const plotW = canvas.width - pad * 2;
            const plotH = canvas.height - pad * 2;

            // Draw regions first (if available)
            const regions = data.regions?.[`level_${level}`] || [];
            regions.forEach((region, idx) => {
                if (region.vertices && region.vertices.length > 2) {
                    ctx.beginPath();
                    const scaledVertices = region.vertices.map(v => ({
                        x: pad + ((v[0] - minX) / (maxX - minX)) * plotW,
                        y: pad + ((v[1] - minY) / (maxY - minY)) * plotH
                    }));
                    
                    ctx.moveTo(scaledVertices[0].x, scaledVertices[0].y);
                    for (let i = 1; i < scaledVertices.length; i++) {
                        ctx.lineTo(scaledVertices[i].x, scaledVertices[i].y);
                    }
                    ctx.closePath();
                    
                    const color = levelColors[level][idx % levelColors[level].length];
                    ctx.fillStyle = color + '30'; // Add transparency
                    ctx.fill();
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });

            // Draw points
            imagePoints.forEach(pt => {
                const x = pad + ((pt.x - minX) / (maxX - minX)) * plotW;
                const y = pad + ((pt.y - minY) / (maxY - minY)) * plotH;
                
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                
                // Color by cluster if available
                const clusterInfo = pt.hierarchicalClusters;
                if (clusterInfo) {
                    const clusterId = clusterInfo[`level_${level}`] || 0;
                    ctx.fillStyle = levelColors[level][clusterId % levelColors[level].length];
                } else {
                    ctx.fillStyle = '#333';
                }
                
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.stroke();
            });

            // Add level indicator
            ctx.font = 'bold 18px Arial';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'left';
            ctx.fillText(`Level ${level} Clusters`, 20, 30);
        }

        function updateLegend(level) {
            const legendDiv = document.getElementById('legend');
            const clusterCount = parseInt(document.getElementById(`level_${level}_clusters`).value);
            
            let legendHTML = '';
            for (let i = 0; i < Math.min(clusterCount, levelColors[level].length); i++) {
                const color = levelColors[level][i];
                legendHTML += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${color}"></div>
                        <span>Cluster ${i + 1}</span>
                    </div>
                `;
            }
            
            legendDiv.innerHTML = legendHTML;
        }

        // Test on Enter key
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !document.getElementById('generateBtn').disabled) {
                generateHierarchicalMap();
            }
        });
    </script>
</body>
</html>