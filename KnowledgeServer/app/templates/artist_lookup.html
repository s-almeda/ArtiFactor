<!DOCTYPE html>
<html>
<head>
    <title>Artist Database Lookup</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>Artist Database Lookup</h1>
        
        <div class="section">
            <h2>Step 1: Enter Artist Name</h2>
            <div class="input-group">
                <input type="text" id="first_name" placeholder="First Name">
                <input type="text" id="last_name" placeholder="Last Name">
                <button onclick="lookupArtist()">Lookup Artist</button>
            </div>
            <div id="status"></div>
        </div>
        
        <div class="section" id="wikiart_info_section" style="display: none;">
            <h2>Step 2: WikiArt Information</h2>
            <div class="field-label">Slug: <span id="slug_display"></span></div>
            <div id="parsed_info"></div>
            <details>
                <summary>Raw HTML Preview (click to expand)</summary>
                <div class="html-preview" id="html_preview"></div>
            </details>
        </div>
        
        <div class="section form-section" id="artist_form_section">
            <h2>Step 3: Artist Database Entry</h2>
            <div id="database_status"></div>
            <form id="artistForm">
                <input type="hidden" name="entry_id" id="entry_id">
                
                <div class="field-label">Artist Name</div>
                <input type="text" name="value" id="artist_value" required>
                
                <div class="field-label">Type</div>
                <input type="text" name="type" value="artist" readonly>
                
                <input type="hidden" name="isArtist" value="1">
                
                <div class="field-label">Artist Aliases</div>
                <div class="field-hint">JSON array of alternative names</div>
                <textarea name="artist_aliases" rows="2">[]</textarea>
                
                <div class="field-label">Images</div>
                <div class="field-hint">JSON array of image IDs</div>
                <textarea name="images" rows="2">[]</textarea>
                
                <div class="field-label">Descriptions</div>
                <div class="field-hint">JSON object with source descriptions</div>
                <textarea name="descriptions" rows="4">{}</textarea>

                <div class="field-label">Auto-Generate Keywords</div>
                <button type="button" onclick="generateKeywords()" id="generate_keywords_btn">üîç Find Related Keywords</button>
                <div id="keyword_status"></div>

                <div id="keyword_checklist" style="display: none;">
                    <div class="field-label">Select Related Keywords:</div>
                    <div id="keyword_checkboxes" class="keyword-checkbox-container"></div>
                </div>

                <div class="field-label">Related Keyword IDs</div>
                <textarea name="relatedKeywordIds" rows="2">[]</textarea>
                
                <div class="field-label">Related Keyword Strings</div>
                <textarea name="relatedKeywordStrings" rows="2">[]</textarea>


                <button type="button" onclick="getArtworks()" id="get_artworks_btn">üé® Get Artist's Artworks</button>

                <div id="artwork_status"></div>

                <div id="artwork_list" style="display: none;">
                    <div class="field-label">Artist's Artworks:</div>
                    <div id="artwork_container" class="artwork-list-container"></div>
                    <button type="button" onclick="checkDataBeforeSubmission()" class="check-data-btn">
                        üîç Check Data Before Submission
                    </button>
                    <div id="data_validation_results" style="display: none;"></div>
                </div>

                
                <button type="submit" id="submit_button">Add to Database</button>
            </form>
            <div id="form_result"></div>
        </div>
    </div>
    
    <script>
        let isUpdating = false;
        
        // JavaScript version of the slugify function
        function slugify(name) {
            // Convert to lowercase
            name = name.toLowerCase().trim();
            
            // Replace accented characters
            const accents = {
                '√†': 'a', '√°': 'a', '√§': 'a', '√¢': 'a', '√£': 'a', '√•': 'a', 'ƒÅ': 'a',
                '√®': 'e', '√©': 'e', '√´': 'e', '√™': 'e', 'ƒì': 'e',
                '√¨': 'i', '√≠': 'i', '√Ø': 'i', '√Æ': 'i', 'ƒ´': 'i',
                '√≤': 'o', '√≥': 'o', '√∂': 'o', '√¥': 'o', '√µ': 'o', '√∏': 'o', '≈ç': 'o',
                '√π': 'u', '√∫': 'u', '√º': 'u', '√ª': 'u', '≈´': 'u',
                '√±': 'n', '√ß': 'c', '≈õ': 's', '≈∫': 'z', '≈º': 'z',
                'ƒÖ': 'a', 'ƒô': 'e', '≈Ç': 'l', '≈Ñ': 'n', '≈°': 's', 'ƒç': 'c', '≈ô': 'r',
                '√∞': 'd', '√æ': 'th', '√ü': 'ss'
            };
            
            for (const [accent, replacement] of Object.entries(accents)) {
                name = name.replace(new RegExp(accent, 'g'), replacement);
            }
            
            // Replace spaces with hyphens
            name = name.replace(/\s+/g, '-');
            
            // Remove any remaining non-alphanumeric characters except hyphens
            name = name.replace(/[^a-z0-9-]/g, '');
            
            // Remove multiple consecutive hyphens
            name = name.replace(/-+/g, '-');
            
            // Remove leading/trailing hyphens
            name = name.replace(/^-+|-+$/g, '');
            
            return name;
        }
        
        async function lookupArtist() {
            const firstName = document.getElementById('first_name').value.trim();
            const lastName = document.getElementById('last_name').value.trim();
            
            if (!firstName || !lastName) {
                showStatus('Please enter both first and last name', 'error');
                return;
            }
            
            showStatus('Processing...', 'info');
            
            try {
                const response = await fetch('/artist_lookup/process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ first_name: firstName, last_name: lastName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show the slug and parsed info
                    document.getElementById('slug_display').textContent = result.slug;
                    
                    // Display parsed WikiArt information
                    const parsedInfoDiv = document.getElementById('parsed_info');
                    if (result.artist_info && Object.keys(result.artist_info).length > 0) {
                        let infoHtml = '<div class="parsed-artist-info"><h3>Extracted Information:</h3>';
                        
                        // Handle Wikipedia section
                        if (result.artist_info.wikipedia) {
                            infoHtml += '<h4>Wikipedia Information:</h4>';
                            for (const [key, value] of Object.entries(result.artist_info.wikipedia)) {
                                const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                if (key === 'link') {
                                    infoHtml += `<div><strong>${label}:</strong> <a href="${value}" target="_blank">${value}</a></div>`;
                                } else {
                                    // Truncate long text like article excerpt
                                    const displayValue = value.length > 200 ? value.substring(0, 200) + '...' : value;
                                    infoHtml += `<div><strong>${label}:</strong> ${displayValue}</div>`;
                                }
                            }
                        }
                        
                        // Handle structured data section
                        if (result.artist_info.structured_data) {
                            infoHtml += '<h4>Artist Details:</h4>';
                            for (const [key, value] of Object.entries(result.artist_info.structured_data)) {
                                const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                if (key === 'image_url') {
                                    infoHtml += `<div><strong>${label}:</strong> <img src="${value}" alt="Artist" style="max-width: 100px; max-height: 100px;"></div>`;
                                } else {
                                    infoHtml += `<div><strong>${label}:</strong> ${value}</div>`;
                                }
                            }
                        }
                        
                        infoHtml += '</div>';
                        parsedInfoDiv.innerHTML = infoHtml;
                    } else {
                        parsedInfoDiv.innerHTML = '<div class="status warning">No structured information could be extracted from WikiArt page</div>';
                    }
                    
                    // Show raw HTML in collapsible section
                    document.getElementById('html_preview').textContent = result.html_content;
                    document.getElementById('wikiart_info_section').style.display = 'block';
                    
                    // Setup the form
                    if (result.existing_artist) {
                        showDatabaseStatus('Artist already exists in database. Form will update existing entry.', 'info');
                        document.getElementById('submit_button').textContent = 'Update Artist';
                        isUpdating = true;
                        
                        // Pre-fill form with existing data
                        document.getElementById('entry_id').value = result.existing_artist.entry_id;
                        document.getElementById('artist_value').value = result.existing_artist.value;
                        document.querySelector('[name="artist_aliases"]').value = 
                            JSON.stringify(result.existing_artist.artist_aliases || [], null, 2);
                        document.querySelector('[name="images"]').value = 
                            JSON.stringify(result.existing_artist.images || [], null, 2);
                        
                        // Merge WikiArt data with existing descriptions
                        let existingDescriptions = {};
                        try {
                            existingDescriptions = JSON.parse(result.existing_artist.descriptions || '{}');
                        } catch (e) {
                            existingDescriptions = {};
                        }
                        
                        // Add/update WikiArt data
                        if (result.artist_info) {
                            existingDescriptions.wikiart = {};
                            
                            // Add Wikipedia data
                            if (result.artist_info.wikipedia) {
                                if (result.artist_info.wikipedia.article_excerpt) {
                                    existingDescriptions.wikiart.description = result.artist_info.wikipedia.article_excerpt;
                                }
                                if (result.artist_info.wikipedia.link) {
                                    existingDescriptions.wikiart.link = result.artist_info.wikipedia.link;
                                }
                                if (result.artist_info.wikipedia.license) {
                                    existingDescriptions.wikiart.license = result.artist_info.wikipedia.license;
                                }
                            }
                            
                            // Add all structured data
                            if (result.artist_info.structured_data) {
                                for (const [key, value] of Object.entries(result.artist_info.structured_data)) {
                                    if (key !== 'name' && key !== 'image_url') {
                                        existingDescriptions.wikiart[key] = value;
                                    }
                                }
                            }
                        }
                        
                        document.querySelector('[name="descriptions"]').value = JSON.stringify(existingDescriptions, null, 2);
                        document.querySelector('[name="relatedKeywordIds"]').value = 
                            JSON.stringify(result.existing_artist.relatedKeywordIds || [], null, 2);
                        document.querySelector('[name="relatedKeywordStrings"]').value = 
                            JSON.stringify(result.existing_artist.relatedKeywordStrings || [], null, 2);
                    } else {
                        showDatabaseStatus('Artist not in database. Form will create new entry.', 'success');
                        document.getElementById('submit_button').textContent = 'Add to Database';
                        isUpdating = false;
                        
                        // Generate new ID
                        document.getElementById('entry_id').value = 'm' + Math.random().toString(16).substr(2, 23);
                        
                        // Set artist name from meta tag or fallback to input names
                        let artistName = firstName + ' ' + lastName;
                        if (result.artist_info && result.artist_info.structured_data && result.artist_info.structured_data.name) {
                            artistName = result.artist_info.structured_data.name;
                        }
                        document.getElementById('artist_value').value = artistName;
                        
                        // Create artist aliases from the name
                        const aliases = [];
                        if (artistName.includes(' ')) {
                            const nameParts = artistName.split(' ');
                            const firstName = nameParts[0];
                            const lastName = nameParts.slice(1).join(' ');
                            
                            // Create alias object with preserved fancy characters
                            const alias = {
                                name: artistName,
                                sortable_name: `${lastName} ${firstName}`,
                                last: lastName,
                                first: firstName,
                                slug: slugify(artistName) // Use the existing slugify function
                            };
                            aliases.push(alias);
                        }
                        document.querySelector('[name="artist_aliases"]').value = JSON.stringify(aliases, null, 2);
                        
                        // Auto-populate descriptions with ALL WikiArt data
                        const descriptions = {};
                        if (result.artist_info) {
                            descriptions.wikiart = {};
                            
                            // Add Wikipedia data
                            if (result.artist_info.wikipedia) {
                                if (result.artist_info.wikipedia.article_excerpt) {
                                    descriptions.wikiart.description = result.artist_info.wikipedia.article_excerpt;
                                }
                                if (result.artist_info.wikipedia.link) {
                                    descriptions.wikiart.link = result.artist_info.wikipedia.link;
                                }
                                if (result.artist_info.wikipedia.license) {
                                    descriptions.wikiart.license = result.artist_info.wikipedia.license;
                                }
                            }
                            
                            // Add all structured data
                            if (result.artist_info.structured_data) {
                                for (const [key, value] of Object.entries(result.artist_info.structured_data)) {
                                    if (key !== 'name' && key !== 'image_url') { // Skip name (already used) and image_url (handled separately)
                                        descriptions.wikiart[key] = value;
                                    }
                                }
                            }
                        }
                        document.querySelector('[name="descriptions"]').value = JSON.stringify(descriptions, null, 2);
                    }
                    
                    document.getElementById('artist_form_section').style.display = 'block';
                    showStatus('WikiArt page loaded and parsed successfully!', 'success');
                    
                } else {
                    showStatus('Error: ' + result.error, 'error');
                    document.getElementById('wikiart_info_section').style.display = 'none';
                    document.getElementById('artist_form_section').style.display = 'none';
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }
        
        function showDatabaseStatus(message, type) {
            const statusDiv = document.getElementById('database_status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }

        let availableKeywords = []; // Store all retrieved keywords

        async function generateKeywords() {
            const generateBtn = document.getElementById('generate_keywords_btn');
            const statusDiv = document.getElementById('keyword_status');
            const checklistDiv = document.getElementById('keyword_checklist');
            
            // Disable button and show processing
            generateBtn.disabled = true;
            generateBtn.textContent = 'üîÑ Generating...';
            statusDiv.innerHTML = '<div class="status info">Searching for related keywords...</div>';
            checklistDiv.style.display = 'none';
            
            try {
                // Compile all text from the form
                const artistName = document.getElementById('artist_value').value;
                const descriptionsText = document.querySelector('[name="descriptions"]').value;
                
                let compiledText = artistName;
                
                // Parse descriptions and extract text content
                try {
                    const descriptions = JSON.parse(descriptionsText);
                    for (const [source, data] of Object.entries(descriptions)) {
                        if (typeof data === 'object') {
                            // Handle nested objects like wikiart data
                            for (const [key, value] of Object.entries(data)) {
                                if (typeof value === 'string' && key !== 'link') {
                                    compiledText += ' ' + value;
                                }
                            }
                        } else if (typeof data === 'string') {
                            compiledText += ' ' + data;
                        }
                    }
                } catch (e) {
                    // If JSON parsing fails, use raw text
                    compiledText += ' ' + descriptionsText;
                }
                
                // Call the lookup API
                const response = await fetch('/lookup_text', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: compiledText,
                        top_k: 15  // Get more results to filter
                    })
                });
                
                const results = await response.json();
                
                if (results && results.length > 0) {
                    // Filter out artists and get only keywords/subjects
                    availableKeywords = results.filter(item => !item.isArtist);
                    
                    if (availableKeywords.length > 0) {
                        displayKeywordCheckboxes();
                        statusDiv.innerHTML = `<div class="status success">‚úÖ Found ${availableKeywords.length} potential keywords</div>`;
                        checklistDiv.style.display = 'block';
                    } else {
                        statusDiv.innerHTML = '<div class="status warning">No related keywords found</div>';
                    }
                } else {
                    statusDiv.innerHTML = '<div class="status warning">No related keywords found</div>';
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            } finally {
                // Re-enable button
                generateBtn.disabled = false;
                generateBtn.textContent = 'üîç Find Related Keywords';
            }
        }

        function displayKeywordCheckboxes() {
            const checkboxContainer = document.getElementById('keyword_checkboxes');
            checkboxContainer.innerHTML = '';
            
            availableKeywords.forEach((keyword, index) => {
            const checkboxItem = document.createElement('div');
            checkboxItem.className = 'keyword-checkbox-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `keyword_${index}`;
            checkbox.checked = false; // Default to unchecked
            checkbox.addEventListener('change', updateKeywordLists);
            
            const label = document.createElement('label');
            label.htmlFor = `keyword_${index}`;
            label.textContent = `${keyword.value} (${keyword.type})`;
            
            checkboxItem.appendChild(checkbox);
            checkboxItem.appendChild(label);
            checkboxContainer.appendChild(checkboxItem);
            });
            
            // Initial update with none selected
            updateKeywordLists();
        }

        function updateKeywordLists() {
            const selectedKeywords = [];
            const selectedIds = [];
            const selectedStrings = [];
            
            availableKeywords.forEach((keyword, index) => {
            const checkbox = document.getElementById(`keyword_${index}`);
            if (checkbox && checkbox.checked) {
                selectedIds.push(keyword.entry_id);
                selectedStrings.push(keyword.value);
            }
            });
            
            // Update form fields
            document.querySelector('[name="relatedKeywordIds"]').value = 
            JSON.stringify(selectedIds, null, 2);
            document.querySelector('[name="relatedKeywordStrings"]').value = 
            JSON.stringify(selectedStrings, null, 2);
        }



        let artworkList = []; // Store fetched artworks

        async function getArtworks() {
            const getArtworksBtn = document.getElementById('get_artworks_btn');
            const statusDiv = document.getElementById('artwork_status');
            const artworkListDiv = document.getElementById('artwork_list');
            
            // Disable button and show processing
            getArtworksBtn.disabled = true;
            getArtworksBtn.textContent = 'üîÑ Fetching Artworks...';
            statusDiv.innerHTML = '<div class="status info">Loading artist\'s artworks from WikiArt...</div>';
            artworkListDiv.style.display = 'none';
            
            try {
                // Get the current slug from the displayed slug
                const slug = document.getElementById('slug_display').textContent;
                
                if (!slug) {
                    throw new Error('No artist slug available. Please lookup an artist first.');
                }
                
                // Call the backend to fetch artworks
                const response = await fetch('/artist_lookup/get_artworks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ slug: slug })
                });
                
                const result = await response.json();
                
                if (result.success && result.artworks.length > 0) {
                    artworkList = result.artworks;
                    displayArtworkList();
                    statusDiv.innerHTML = `<div class="status success">‚úÖ Found ${artworkList.length} artworks</div>`;
                    artworkListDiv.style.display = 'block';
                } else {
                    statusDiv.innerHTML = '<div class="status warning">No artworks found for this artist</div>';
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            } finally {
                // Re-enable button
                getArtworksBtn.disabled = false;
                getArtworksBtn.textContent = 'üé® Get Artist\'s Artworks';
            }
        }

        function displayArtworkList() {
            const container = document.getElementById('artwork_container');
            container.innerHTML = '';
            
            artworkList.forEach((artwork, index) => {
                const artworkItem = document.createElement('div');
                artworkItem.className = 'artwork-item';
                artworkItem.dataset.index = index;
                
                // Add click handler for fetching artwork details
                artworkItem.addEventListener('click', () => {
                    if (!artworkItem.classList.contains('selected')) {
                        fetchArtworkDetails(artwork, artworkItem, index);
                    }
                    artworkItem.classList.toggle('selected');
                });
                
                artworkItem.innerHTML = `
                    <img src="${artwork.thumbnail_url}" alt="${artwork.title}" class="artwork-thumbnail" 
                        onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
                    <div class="artwork-details">
                        <div class="artwork-title">${artwork.title}</div>
                        <div class="artwork-year">${artwork.year || 'Unknown year'}</div>
                        <div class="artwork-url">${artwork.wikiart_url}</div>
                    </div>
                    <div id="artwork-details-${index}" class="artwork-details-container" style="display: none;"></div>
                `;
                
                container.appendChild(artworkItem);
            });
        }

        async function fetchArtworkDetails(artwork, artworkElement, index) {
            const detailsContainer = artworkElement.querySelector(`#artwork-details-${index}`);
            
            // Show loading state
            detailsContainer.style.display = 'block';
            detailsContainer.innerHTML = '<div class="status info">üîÑ Loading artwork details...</div>';
            
            try {
                const response = await fetch('/artist_lookup/get_artwork_details', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        artwork_url: artwork.wikiart_url,
                        artwork_title: artwork.title
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayArtworkDetails(result.artwork_data, detailsContainer, index);
                } else {
                    detailsContainer.innerHTML = `<div class="status error">‚ùå Error: ${result.error}</div>`;
                }
                
            } catch (error) {
                detailsContainer.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }


        function displayArtworkList() {
            const container = document.getElementById('artwork_container');
            container.innerHTML = '';
            
            artworkList.forEach((artwork, index) => {
                const artworkItem = document.createElement('div');
                artworkItem.className = 'artwork-item';
                artworkItem.dataset.index = index;
                
                artworkItem.innerHTML = `
                    <input type="checkbox" id="artwork-checkbox-${index}" class="artwork-checkbox">
                    <img src="${artwork.thumbnail_url}" alt="${artwork.title}" class="artwork-thumbnail" 
                        onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
                    <div class="artwork-details">
                        <div class="artwork-title">${artwork.title}</div>
                        <div class="artwork-year">${artwork.year || 'Unknown year'}</div>
                        <div class="artwork-url">${artwork.wikiart_url}</div>
                        <button type="button" onclick="fetchArtworkDetails(${index})" class="fetch-details-btn">
                            üìã Get Details
                        </button>
                    </div>
                    <div id="artwork-details-${index}" class="artwork-details-container" style="display: none;"></div>
                `;
                
                container.appendChild(artworkItem);
            });
        }

        async function fetchArtworkDetails(index) {
            const artwork = artworkList[index];
            const detailsContainer = document.getElementById(`artwork-details-${index}`);
            const fetchBtn = document.querySelector(`[onclick="fetchArtworkDetails(${index})"]`);
            
            // Disable button and show loading
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'üîÑ Loading...';
            
            // Show loading state
            detailsContainer.style.display = 'block';
            detailsContainer.innerHTML = '<div class="status info">üîÑ Loading artwork details...</div>';
            
            try {
                const response = await fetch('/artist_lookup/get_artwork_details', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        artwork_url: artwork.wikiart_url,
                        artwork_title: artwork.title
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Automatically copy artist keywords
                    const currentKeywordIds = JSON.parse(document.querySelector('[name="relatedKeywordIds"]').value || '[]');
                    const currentKeywordStrings = JSON.parse(document.querySelector('[name="relatedKeywordStrings"]').value || '[]');
                    const artistEntryId = document.getElementById('entry_id').value;
                    const artistName = document.getElementById('artist_value').value;
                    
                    // Add artist keywords to artwork data
                    result.artwork_data.relatedKeywordIds = [...currentKeywordIds, artistEntryId];
                    result.artwork_data.relatedKeywordStrings = [...currentKeywordStrings, artistName];
                    
                    displayArtworkDetails(result.artwork_data, detailsContainer, index);
                    fetchBtn.textContent = '‚úÖ Details Loaded';
                } else {
                    detailsContainer.innerHTML = `<div class="status error">‚ùå Error: ${result.error}</div>`;
                    fetchBtn.textContent = '‚ùå Failed';
                }
                
            } catch (error) {
                detailsContainer.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                fetchBtn.textContent = '‚ùå Error';
            }
        }

        function displayArtworkDetails(artworkData, container, index) {
            container.innerHTML = `
                <div class="artwork-parsed-details">
                    <details open>
                        <summary><strong>Artwork Database Entry Preview</strong></summary>
                        <ul class="artwork-detail-list">
                            <li><strong>Image ID:</strong> ${artworkData.image_id}</li>
                            <li><strong>Title:</strong> ${artworkData.value}</li>
                            <li><strong>Artist Names:</strong> ${JSON.stringify(artworkData.artist_names)}</li>
                            <li><strong>Image URLs:</strong> 
                                <ul>
                                    <li>Large: ${artworkData.image_urls.large || 'N/A'}</li>
                                    <li>Medium: ${artworkData.image_urls.medium || 'N/A'}</li>
                                    <li>Small: ${artworkData.image_urls.small || 'N/A'}</li>
                                </ul>
                            </li>
                            <li><strong>Downloaded Filename:</strong> ${artworkData.filename}</li>
                            <li><strong>Rights:</strong> ${artworkData.rights || 'Unknown'}</li>
                            <li><strong>Descriptions:</strong> 
                                <div class="descriptions-preview">${JSON.stringify(artworkData.descriptions || {}, null, 2)}</div>
                            </li>
                            <li><strong>Related Keywords:</strong> ${JSON.stringify(artworkData.relatedKeywordStrings)}</li>
                        </ul>
                        <div class="artwork-actions">
                            <button type="button" onclick="downloadArtworkImage(${index})" class="download-image-btn">
                                üíæ Download Image
                            </button>
                        </div>
                        <div id="artwork-action-status-${index}"></div>
                    </details>
                </div>
            `;
            
            // Store the artwork data for later use
            artworkList[index].parsed_data = artworkData;
        }

        async function downloadArtworkImage(artworkIndex) {
            const artworkData = artworkList[artworkIndex].parsed_data;
            const statusDiv = document.getElementById(`artwork-action-status-${artworkIndex}`);
            const downloadBtn = document.querySelector(`[onclick="downloadArtworkImage(${artworkIndex})"]`);
            
            // Disable button and show loading
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'üîÑ Downloading...';
            statusDiv.innerHTML = '<div class="status info">üîÑ Downloading image...</div>';
            
            try {
                const response = await fetch('/artist_lookup/download_image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        image_url: artworkData.image_urls.small,
                        image_id: artworkData.image_id,
                        filename: artworkData.filename
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `<div class="status success">‚úÖ Downloaded: ${result.filename}</div>`;
                    downloadBtn.textContent = '‚úÖ Downloaded';
                    
                    // Mark that this artwork has been downloaded
                    artworkData.downloaded = true;
                } else {
                    statusDiv.innerHTML = `<div class="status error">‚ùå Download failed: ${result.error}</div>`;
                    downloadBtn.textContent = 'üíæ Download Image';
                    downloadBtn.disabled = false;
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                downloadBtn.textContent = 'üíæ Download Image';
                downloadBtn.disabled = false;
            }
        }


        async function checkDataBeforeSubmission() {
            const checkBtn = document.querySelector('.check-data-btn');
            const resultsDiv = document.getElementById('data_validation_results');
            
            console.log("=== STARTING DATA VALIDATION ===");
            
            checkBtn.disabled = true;
            checkBtn.textContent = 'üîÑ Validating Data...';
            
            try {
                // Get selected artworks
                const selectedArtworks = [];
                const selectedImageIds = [];
                
                console.log("Checking artworkList:", artworkList);
                console.log("artworkList length:", artworkList.length);
                
                artworkList.forEach((artwork, index) => {
                    console.log(`Checking artwork ${index}:`, artwork);
                    
                    const checkbox = document.getElementById(`artwork-checkbox-${index}`);
                    console.log(`Checkbox ${index}:`, checkbox);
                    console.log(`Checkbox checked:`, checkbox ? checkbox.checked : 'checkbox not found');
                    console.log(`Parsed data exists:`, artwork.parsed_data ? 'yes' : 'no');
                    
                    if (checkbox && checkbox.checked && artwork.parsed_data) {
                        selectedArtworks.push(artwork.parsed_data);
                        selectedImageIds.push(artwork.parsed_data.image_id);
                        console.log(`Added artwork ${index} to selection:`, artwork.parsed_data.value);
                    }
                });
                
                console.log("Selected artworks:", selectedArtworks);
                console.log("Selected image IDs:", selectedImageIds);
                
                // Update the images field in the form
                document.querySelector('[name="images"]').value = JSON.stringify(selectedImageIds, null, 2);
                console.log("Updated images field in form");
                
                // Collect all form data
                const formElement = document.getElementById('artistForm');
                if (!formElement) {
                    throw new Error('Artist form not found');
                }
                
                const formData = new FormData(formElement);
                const artistData = Object.fromEntries(formData);
                console.log("Artist data:", artistData);
                
                // Validate we have required data
                if (!artistData.entry_id) {
                    throw new Error('Artist entry_id is missing');
                }
                if (!artistData.value) {
                    throw new Error('Artist name is missing');
                }
                
                // Display validation results
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="status info">üîÑ Running validation checks...</div>';
                
                console.log("Sending validation request with data:", {
                    artist_data: artistData,
                    selected_artworks: selectedArtworks
                });
                
                const response = await fetch('/artist_lookup/validate_data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        artist_data: artistData,
                        selected_artworks: selectedArtworks
                    })
                });
                
                console.log("Validation response status:", response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log("Validation result:", result);
                
                if (result.success) {
                    displayValidationResults(result.validation, artistData, selectedArtworks);
                } else {
                    console.error("Validation failed:", result.error);
                    resultsDiv.innerHTML = `<div class="status error">‚ùå Validation failed: ${result.error}</div>`;
                }
                
            } catch (error) {
                console.error("Error during validation:", error);
                console.error("Error stack:", error.stack);
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error during validation: ${error.message}</div>`;
            } finally {
                checkBtn.disabled = false;
                checkBtn.textContent = 'üîç Check Data Before Submission';
                console.log("=== VALIDATION COMPLETE ===");
            }
        }

        

        function displayValidationResults(validation, artistData, selectedArtworks) {
            console.log("=== DISPLAYING VALIDATION RESULTS ===");
            console.log("Validation object:", validation);
            console.log("Artist data:", artistData);
            console.log("Selected artworks:", selectedArtworks);
            
            const resultsDiv = document.getElementById('data_validation_results');
            
            try {
                let html = '<div class="validation-container">';
                
                // Overall Status
                html += '<div class="validation-section">';
                html += '<div class="validation-header">üìã Overall Validation Status</div>';
                if (validation.overall_valid) {
                    html += '<div class="validation-item validation-success">‚úÖ All checks passed! Ready for database insertion.</div>';
                } else {
                    html += '<div class="validation-item validation-error">‚ùå Some checks failed. Please review below.</div>';
                }
                html += '</div>';
                
                // Artist Data Preview - Clean Format
                html += '<div class="validation-section">';
                html += '<div class="validation-header">üë§ Artist Data (text_entries)</div>';
                
                if (validation.artist_preview) {
                    html += '<div class="json-preview">' + JSON.stringify(validation.artist_preview, null, 2) + '</div>';
                } else {
                    console.error("artist_preview is missing from validation object");
                    html += '<div class="validation-error">‚ùå Artist preview data missing</div>';
                }
                
                // JSON Validation for Artist
                if (validation.artist_json_valid) {
                    html += '<div class="validation-item validation-success">‚úÖ All artist JSON fields are valid</div>';
                } else {
                    html += '<div class="validation-item validation-error">‚ùå Artist JSON validation errors: ' + (validation.artist_json_errors || []).join(', ') + '</div>';
                }
                html += '</div>';
                
                // Selected Artworks Preview - Clean Format
                html += '<div class="validation-section">';
                html += `<div class="validation-header">üé® Selected Artworks (${selectedArtworks.length} items for image_entries)</div>`;
                
                selectedArtworks.forEach((artwork, index) => {
                    console.log(`Processing artwork ${index} for display:`, artwork);
                    
                    html += `<div class="artwork-validation-item" style="border: 1px solid #ddd; margin: 15px 0; padding: 15px; border-radius: 4px;">`;
                    html += `<div style="font-weight: bold; margin-bottom: 10px;">${artwork.value || 'Unknown Title'}</div>`;
                    
                    // Clean artwork preview
                    const cleanArtworkPreview = {
                        image_id: artwork.image_id,
                        title: artwork.value,
                        artist_names: artwork.artist_names,
                        image_urls: artwork.image_urls,
                        filename: artwork.filename,
                        rights: artwork.rights,
                        descriptions: artwork.descriptions,
                        relatedKeywordIds: artwork.relatedKeywordIds,
                        relatedKeywordStrings: artwork.relatedKeywordStrings
                    };
                    
                    html += '<div class="json-preview" style="margin-bottom: 10px;">' + JSON.stringify(cleanArtworkPreview, null, 2) + '</div>';
                    
                    // Validation checks
                    html += '<div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">';
                    
                    // JSON validation for this artwork
                    const artworkJsonValid = validation.artworks_json_valid && validation.artworks_json_valid[index];
                    if (artworkJsonValid) {
                        html += '<span class="validation-success">‚úÖ JSON valid</span>';
                    } else {
                        html += '<span class="validation-error">‚ùå JSON invalid</span>';
                        console.error(`Artwork ${index} failed JSON validation`);
                    }
                    
                    // File existence check with download button if missing
                    const fileExists = validation.files_exist && validation.files_exist[index];
                    if (fileExists) {
                        html += '<span class="validation-success">‚úÖ File exists</span>';
                        html += `<img src="/static/images/${artwork.filename}" class="tiny-image" onerror="this.style.display='none'">`;
                    } else {
                        html += '<span class="validation-error">‚ùå File missing</span>';
                        html += `<button type="button" onclick="downloadMissingImage(${index})" class="download-missing-btn" id="download-btn-${index}">üíæ Download Image</button>`;
                    }
                    
                    // Image URL validation
                    const urlsValid = validation.image_urls_valid && validation.image_urls_valid[index];
                    if (urlsValid) {
                        html += '<span class="validation-success">‚úÖ URLs valid</span>';
                        if (artwork.image_urls && artwork.image_urls.small) {
                            html += `<img src="${artwork.image_urls.small}" class="tiny-image" onerror="this.style.display='none'">`;
                        }
                        if (artwork.image_urls && artwork.image_urls.medium && artwork.image_urls.medium !== artwork.image_urls.small) {
                            html += `<img src="${artwork.image_urls.medium}" class="tiny-image" onerror="this.style.display='none'">`;
                        }
                        if (artwork.image_urls && artwork.image_urls.large && artwork.image_urls.large !== artwork.image_urls.medium) {
                            html += `<img src="${artwork.image_urls.large}" class="tiny-image" onerror="this.style.display='none'">`;
                        }
                    } else {
                        html += '<span class="validation-error">‚ùå Invalid URLs</span>';
                        console.error(`Artwork ${index} failed URL validation`);
                    }
                    
                    html += '</div>'; // Close validation checks div
                    html += '</div>'; // Close artwork validation item
                });
                html += '</div>';
                
                // Final submission button
                if (validation.overall_valid) {
                    html += '<div class="validation-section">';
                    html += '<div class="validation-header">üöÄ Ready for Submission</div>';
                    html += '<button type="button" onclick="submitValidatedData()" class="final-submit-btn">‚úÖ Submit All Data to Database</button>';
                    html += '<div id="final_submission_status"></div>';
                    html += '</div>';
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
                console.log("Validation results displayed successfully");
                
            } catch (error) {
                console.error("Error displaying validation results:", error);
                console.error("Error stack:", error.stack);
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error displaying results: ${error.message}</div>`;
            }
            
            console.log("=== END DISPLAYING VALIDATION RESULTS ===");
        }

        // New function for downloading missing images
        async function downloadMissingImage(artworkIndex) {
            const artwork = artworkList[artworkIndex].parsed_data;
            const downloadBtn = document.getElementById(`download-btn-${artworkIndex}`);
            
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'üîÑ Downloading...';
            
            try {
                const response = await fetch('/artist_lookup/download_image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        image_url: artwork.image_urls.small,
                        image_id: artwork.image_id,
                        filename: artwork.filename
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    downloadBtn.textContent = '‚úÖ Downloaded';
                    downloadBtn.style.background = '#28a745';
                    
                    // Re-run validation to update the display
                    setTimeout(() => {
                        checkDataBeforeSubmission();
                    }, 1000);
                } else {
                    downloadBtn.textContent = '‚ùå Failed';
                    downloadBtn.disabled = false;
                    alert(`Download failed: ${result.error}`);
                }
                
            } catch (error) {
                downloadBtn.textContent = 'üíæ Download Image';
                downloadBtn.disabled = false;
                alert(`Error: ${error.message}`);
            }
        }



        async function submitValidatedData() {
            const submitBtn = document.querySelector('.final-submit-btn');
            const statusDiv = document.getElementById('final_submission_status');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'üîÑ Submitting to Database...';
            statusDiv.innerHTML = '<div class="status info">üîÑ Inserting data into database...</div>';
            
            try {
                // Get all the data again
                const selectedArtworks = [];
                artworkList.forEach((artwork, index) => {
                    const checkbox = document.getElementById(`artwork-checkbox-${index}`);
                    if (checkbox && checkbox.checked && artwork.parsed_data) {
                        selectedArtworks.push(artwork.parsed_data);
                    }
                });
                
                const formData = new FormData(document.getElementById('artistForm'));
                const artistData = Object.fromEntries(formData);
                
                const response = await fetch('/artist_lookup/submit_all_data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        artist_data: artistData,
                        selected_artworks: selectedArtworks
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `<div class="status success">‚úÖ Success! Added artist and ${result.artworks_added} artworks to database.</div>`;
                    submitBtn.textContent = '‚úÖ Submitted Successfully';
                } else {
                    statusDiv.innerHTML = `<div class="status error">‚ùå Submission failed: ${result.error}</div>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚úÖ Submit All Data to Database';
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                submitBtn.disabled = false;
                submitBtn.textContent = '‚úÖ Submit All Data to Database';
            }
        }


        function copyArtistKeywords(artworkIndex) {
            const artworkData = artworkList[artworkIndex].parsed_data;
            const statusDiv = document.getElementById(`artwork-action-status-${artworkIndex}`);
            
            try {
                // Get current artist's keywords
                const currentKeywordIds = JSON.parse(document.querySelector('[name="relatedKeywordIds"]').value || '[]');
                const currentKeywordStrings = JSON.parse(document.querySelector('[name="relatedKeywordStrings"]').value || '[]');
                
                // Get artist's entry_id and name
                const artistEntryId = document.getElementById('entry_id').value;
                const artistName = document.getElementById('artist_value').value;
                
                // Combine keywords
                const combinedIds = [...currentKeywordIds, artistEntryId];
                const combinedStrings = [...currentKeywordStrings, artistName];
                
                // Update artwork data
                artworkData.relatedKeywordIds = combinedIds;
                artworkData.relatedKeywordStrings = combinedStrings;
                
                statusDiv.innerHTML = '<div class="status success">‚úÖ Keywords copied from artist</div>';
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Error copying keywords: ${error.message}</div>`;
            }
        }

        document.getElementById('artistForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            const endpoint = isUpdating ? '/artist_lookup/update' : '/artist_lookup/add';
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                const resultDiv = document.getElementById('form_result');
                
                if (result.success) {
                    resultDiv.innerHTML = '<div class="status success">‚úÖ ' + result.message + '</div>';
                } else {
                    resultDiv.innerHTML = '<div class="status error">‚ùå ' + result.error + '</div>';
                }
            } catch (error) {
                document.getElementById('form_result').innerHTML = 
                    '<div class="status error">‚ùå Error: ' + error.message + '</div>';
            }
        };

    </script>
</body>
</html>